<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>✈️ 항공 랜덤 문제 은행</title>
  <style>
    :root { --bg:#0b1b2b; --card:#142032; --muted:#a6a7ab; --text:#f6f7f9; --accent:#3b82f6; --ok:#22c55e; --bad:#ef4444; --line:#2a2b30 }
    body{margin:0; font-family:system-ui,Roboto,Helvetica,Arial; background:var(--bg); color:var(--text)}
    .wrap{max-width:960px; margin:0 auto; padding:24px}
    header{display:flex; gap:12px; align-items:center; margin-bottom:12px}
    h1{font-size:22px; margin:0}
    .tabs{display:flex; gap:8px; margin:12px 0}
    .tab{padding:8px 12px; border:1px solid var(--line); border-radius:10px; background:#101820; color:var(--muted); cursor:pointer}
    .tab.active{background:var(--card); color:var(--text); border-color:#3b82f6}
    .card{background:var(--card); border:1px solid var(--line); border-radius:14px; padding:18px}
    .row{display:flex; gap:8px; align-items:center}
    .btn{padding:8px 12px; background:#1a1b1f; border:1px solid var(--line); border-radius:10px; color:var(--text); cursor:pointer}
    .btn.secondary{background:#111216}
    .btn.ghost{background:transparent}
    .btn:disabled{opacity:.5; cursor:not-allowed}
    .choices{display:grid; gap:10px}
    .choice{display:flex; gap:10px; align-items:center; border:1px solid var(--line); border-radius:12px; padding:10px; transition:0.2s}
    .choice.ok{border-color:var(--ok); background:#07210f}
    .choice.bad{border-color:var(--bad); background:#2b0d0d}
    .muted{color:var(--muted)}
    .spacer{height:8px}
    .grid{display:grid; gap:12px}
    @media(min-width:720px){.grid-2{grid-template-columns:1fr 1fr}}
    code{background:#101114; padding:2px 6px; border-radius:6px; border:1px solid var(--line)}
    header svg.logo{color:#3b82f6}
    /* settings floating icon */
    .settings-fab{position:fixed; right:14px; bottom:14px; width:42px; height:42px; border-radius:50%; display:flex; align-items:center; justify-content:center; background:#0f1622; border:1px solid var(--line); cursor:pointer; box-shadow:0 6px 18px rgba(0,0,0,.25)}
    .settings-fab svg{color:var(--muted)}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <svg class="logo" width="26" height="26" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M2.5 19l19-7-19-7v5l14 2-14 2z"/></svg>
      <h1>✈️ 항공 랜덤 문제 은행</h1>
    </header>

    <div class="tabs">
      <button class="tab active" data-tab="quiz">퀴즈</button>
      <button class="tab" data-tab="wrong">오답노트</button>
      <button class="tab" data-tab="settings">설정</button>
    </div>

    <section id="quiz" class="card">
      <div class="row" style="justify-content:space-between; margin-bottom:10px">
        <div id="q-meta" class="muted">문제 0/0</div>
        <div class="row">
          <button class="btn secondary" id="btn-prev">이전</button>
          <button class="btn" id="btn-next">다음</button>
          <button class="btn ghost" id="btn-shuffle-quiz" title="문제 섞기">섞기</button>
        </div>
      </div>
      <div id="q-question" style="white-space:pre-wrap; font-weight:600; line-height:1.5; margin-bottom:12px">데이터를 불러오세요.</div>
      <div id="q-choices" class="choices"></div>
      <div class="spacer"></div>
      <div class="row" style="gap:10px">
        <button class="btn" id="btn-submit">정답 확인</button>
        <button class="btn secondary" id="btn-reveal">해설 보기</button>
        <button class="btn ghost" id="btn-clear">선택 초기화</button>
      </div>
      <div class="spacer"></div>
      <div id="q-explain" class="muted"></div>
    </section>

    <div class="spacer"></div>

    <section id="wrong" class="card" style="display:none">
      <div class="muted" style="margin-bottom:10px">틀린 문제만 재풀이</div>
      <div class="row" style="justify-content:space-between; margin-bottom:10px">
        <div id="w-meta" class="muted">오답 0/0</div>
        <div class="row">
          <button class="btn secondary" id="w-prev">이전</button>
          <button class="btn" id="w-next">다음</button>
          <button class="btn ghost" id="btn-reset">오답 전부 초기화</button>
        </div>
      </div>
      <div id="w-question" style="white-space:pre-wrap; font-weight:600; line-height:1.5; margin-bottom:12px">오답이 없습니다.</div>
      <div id="w-choices" class="choices"></div>
      <div class="spacer"></div>
      <div class="row" style="gap:10px">
        <button class="btn" id="w-submit">정답 확인</button>
        <button class="btn secondary" id="w-reveal">해설 보기</button>
      </div>
      <div class="spacer"></div>
      <div id="w-explain" class="muted"></div>
    </section>

    <div class="spacer"></div>

    <section id="settings" class="card" style="display:none">
      <div class="grid grid-2">
        <div>
          <div class="muted" style="margin-bottom:6px">데이터 파일</div>
          <div><code>questions.json</code></div>
        </div>
        <div>
          <div class="muted" style="margin-bottom:6px">동작</div>
          <div class="row" style="flex-wrap:wrap; gap:8px">
            <button class="btn" id="btn-reload">데이터 불러오기</button>
          </div>
        </div>
      </div>
      <div class="spacer"></div>
      <div class="muted">index.html, questions.json 같은 폴더에 두고 GitHub Pages로 배포.</div>
    </section>
  </div>

  <!-- settings floating icon -->
  <button id="open-settings" class="settings-fab" title="설정">
    <svg width="22" height="22" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 1 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 1 1-4 0v-.09a1.65 1.65 0 0 0-1-1.51 1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 1 1-2.83-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 1 1 0-4h.09a1.65 1.65 0 0 0 1.51-1 1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 1 1 2.83-2.83l.06.06a1.65 1.65 0 0 0 1.82.33h0A1.65 1.65 0 0 0 9 3.09V3a2 2 0 1 1 4 0v.09a1.65 1.65 0 0 0 1 1.51h0a1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 1 1 2.83 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82v0A1.65 1.65 0 0 0 21 12a1.65 1.65 0 0 0-1.6 1z"/></svg>
  </button>

  <script>
    let all = [], order = [], idx=0;
    let wrongIds = JSON.parse(localStorage.getItem('wrongBank_v1')||'[]');
    let wOrder=[], wIdx=0;
    let picked=null, revealed=false, wPicked=null, wRevealed=false;
    const $=s=>document.querySelector(s);

    function hash(s){let h=0;for(let i=0;i<s.length;i++){h=((h<<5)-h)+s.charCodeAt(i);h|=0;}return String(h>>>0);} 
    function mkId(row){return hash((row.question||'')+'|'+(row.choices||[]).join('|'));}
    function shuffle(a){a=[...a];for(let i=a.length-1;i>0;i--){const j=Math.floor(Math.random()*(i+1));[a[i],a[j]]=[a[j],a[i]];}return a;}

    // 정답 판별 강화: 1~4, A~D, (2), 2., a) + 텍스트(공백/대소문자 무시)
    function normText(s){return String(s).replace(/\s+/g,' ').trim().toLowerCase();}
    function parseAnswerToken(ans){
      const s=String(ans).trim();
      const m=s.match(/^\s*[\(\[]?\s*([1-4]|[A-Da-d])\s*[\)\]\.\-]?\s*$/);
      if(m){ const g=m[1]; if(/[A-Da-d]/.test(g)) return {mode:'index', idx: g.toUpperCase().charCodeAt(0)-65+1}; else return {mode:'index', idx:Number(g)}; }
      return {mode:'text', text:normText(s)};
    }
    function isCorrect(p,row){
      const token=parseAnswerToken(row.correct);
      if(token.mode==='index'){ return String(p)===String(token.idx); }
      const chosen=row.choices[Number(p)-1];
      return normText(chosen)===token.text;
    }

    async function load(){
      const res=await fetch('questions.json',{cache:'no-store'});
      if(!res.ok)throw new Error('questions.json not found');
      const data=await res.json();
      data.forEach(o=>o.id=mkId(o));
      all=data; order=all.map((_,i)=>i);
      // 첫 진입마다 랜덤 순서로 시작
      order = shuffle(order);
      idx=0; renderQuiz(); renderWrong();
    }

    // 탭 전환
    document.querySelectorAll('.tab').forEach(btn=>{
      btn.addEventListener('click',()=>{
        document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        const t=btn.dataset.tab;['quiz','wrong','settings'].forEach(id=>{document.getElementById(id).style.display=(id===t)?'block':'none';});
      });
    });

    // 설정 플로팅 아이콘 → 설정 탭으로 이동
    document.getElementById('open-settings').onclick = ()=>{
      document.querySelectorAll('.tab').forEach(b=>b.classList.remove('active'));
      document.querySelector('[data-tab="settings"]').classList.add('active');
      ['quiz','wrong','settings'].forEach(id=>{document.getElementById(id).style.display=(id==='settings')?'block':'none';});
    };

    function renderQuiz(){
      const qMeta=$('#q-meta'), qQ=$('#q-question'), qC=$('#q-choices'), qE=$('#q-explain');
      if(all.length===0){qMeta.textContent='문제 0/0';qQ.textContent='데이터가 없습니다.';qC.innerHTML='';qE.textContent='';return;}
      const row=all[order[idx]];
      qMeta.textContent=`문제 ${idx+1} / ${order.length}`;
      qQ.textContent=row.question;
      qC.innerHTML='';
      row.choices.forEach((c,i)=>{
        const el=document.createElement('label');el.className='choice';
        el.innerHTML=`<input type="radio" name="q" value="${i+1}"> <div>${String.fromCharCode(65+i)}. ${c}</div>`;
        el.querySelector('input').onchange=(e)=>{picked=e.target.value;paintChoices();};
        qC.appendChild(el);
      });
      qE.textContent='';picked=null;revealed=false;paintChoices();
    }
    function paintChoices(){
      if(all.length===0)return;const row=all[order[idx]];const nodes=[...document.querySelectorAll('#q-choices .choice')];
      nodes.forEach(el=>el.classList.remove('ok','bad'));
      if(revealed){nodes.forEach((el,i)=>{if(isCorrect(String(i+1),row))el.classList.add('ok');else if(picked===String(i+1))el.classList.add('bad');});}
    }

    function buildWrongOrder(){const set=new Set(wrongIds);const idxs=all.map((r,i)=>set.has(r.id)?i:-1).filter(i=>i>=0);wOrder=idxs;wIdx=0;}
    function renderWrong(){buildWrongOrder();const meta=$('#w-meta'),q=$('#w-question'),c=$('#w-choices'),e=$('#w-explain');if(wOrder.length===0){meta.textContent='오답 0/0';q.textContent='오답이 없습니다.';c.innerHTML='';e.textContent='';return;}const row=all[wOrder[wIdx]];meta.textContent=`오답 ${wIdx+1} / ${wOrder.length}`;q.textContent=row.question;c.innerHTML='';row.choices.forEach((ch,i)=>{const el=document.createElement('label');el.className='choice';el.innerHTML=`<input type="radio" name="w" value="${i+1}"> <div>${String.fromCharCode(65+i)}. ${ch}</div>`;el.querySelector('input').onchange=(e)=>{wPicked=e.target.value;paintWrong();};c.appendChild(el);});e.textContent='';wPicked=null;wRevealed=false;paintWrong();}
    function paintWrong(){if(wOrder.length===0)return;const row=all[wOrder[wIdx]];const nodes=[...document.querySelectorAll('#w-choices .choice')];nodes.forEach(el=>el.classList.remove('ok','bad'));if(wRevealed){nodes.forEach((el,i)=>{if(isCorrect(String(i+1),row))el.classList.add('ok');else if(wPicked===String(i+1))el.classList.add('bad');});}}

    // 버튼들
    $('#btn-prev').onclick=()=>{if(all.length===0)return;idx=(idx-1+order.length)%order.length;renderQuiz();};
    $('#btn-next').onclick=()=>{if(all.length===0)return;idx=(idx+1)%order.length;renderQuiz();};
    $('#btn-shuffle-quiz').onclick=()=>{ if(all.length===0) return; order = shuffle(order); idx=0; renderQuiz(); };
    $('#btn-submit').onclick=()=>{if(all.length===0||!picked)return;revealed=true;paintChoices();const row=all[order[idx]];const ok=isCorrect(picked,row);const set=new Set(wrongIds);if(!ok)set.add(row.id);else set.delete(row.id);wrongIds=[...set];localStorage.setItem('wrongBank_v1',JSON.stringify(wrongIds));const exp=(row.explanation||'').trim();$('#q-explain').textContent=exp?`해설: ${exp}`:'';renderWrong();};
    $('#btn-reveal').onclick=()=>{if(all.length===0)return;revealed=true;paintChoices();const row=all[order[idx]];const exp=(row.explanation||'').trim();$('#q-explain').textContent=exp?`해설: ${exp}`:'';};
    $('#btn-clear').onclick=()=>{picked=null;revealed=false;paintChoices();$('#q-explain').textContent='';document.querySelectorAll('#q-choices input[type=radio]').forEach(i=> i.checked=false);};

    $('#w-prev').onclick=()=>{if(wOrder.length===0)return;wIdx=(wIdx-1+wOrder.length)%wOrder.length;renderWrong();};
    $('#w-next').onclick=()=>{if(wOrder.length===0)return;wIdx=(wIdx+1)%wOrder.length;renderWrong();};
    $('#w-submit').onclick=()=>{if(wOrder.length===0||!wPicked)return;wRevealed=true;paintWrong();const row=all[wOrder[wIdx]];const ok=isCorrect(wPicked,row);if(ok){wrongIds=wrongIds.filter(id=>id!==row.id);localStorage.setItem('wrongBank_v1',JSON.stringify(wrongIds));renderWrong();}const exp=(row.explanation||'').trim();$('#w-explain').textContent=exp?`해설: ${exp}`:'';};
    $('#w-reveal').onclick=()=>{if(wOrder.length===0)return;wRevealed=true;paintWrong();const row=all[wOrder[wIdx]];const exp=(row.explanation||'').trim();$('#w-explain').textContent=exp?`해설: ${exp}`:'';};
    $('#btn-reset').onclick=()=>{wrongIds=[];localStorage.setItem('wrongBank_v1','[]');renderWrong();};

    $('#btn-reload').onclick=()=>load();

    load().catch(err=>{console.error(err);alert('questions.json 로드 실패. index.html과 같은 폴더에 두세요.');});
  </script>
</body>
</html>
